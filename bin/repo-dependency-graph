#!/usr/bin/env ruby
require "rubygems"
require "optparse"

$LOAD_PATH << File.join(File.dirname(__FILE__), '..', 'lib')
require "repo_dependency_graph"

def git_config(thing)
  result = `git config #{thing}`.strip
  result.empty? ? nil : result
end

options = {
  :user => git_config("github.user")
}
OptionParser.new do |opts|
  opts.banner = <<BANNER
Draw repo dependency graph from your organization

Usage:
    repo-dependency-graph

Options:
BANNER
  opts.on("--token TOKEN", "Use token") { |token| options[:token] = token }
  opts.on("--user USER", "Use user") { |user| options[:user] = user }
  opts.on("--organization ORGANIZATION", "Use organization") { |organization| options[:organization] = organization }
  opts.on("--private", "Only show private repos") { options[:private] = true }
  opts.on("--external", "Also include external projects in graph (can get super-messy)") { options[:external] = true }
  opts.on("--map SEARCH=REPLACE", "Replace in project name to find them as internal: 'foo=bar' -> replace foo in repo names to bar") do |map|
    options[:map] = map.split("=")
    options[:map][0] = Regexp.new(options[:map][0])
  end
  opts.on("--chef", "Parse chef metadata.rb files") { options[:chef] = true }
  opts.on("--select REGEX", "Only include repos with matching names") { |regex| options[:select] = Regexp.new(regex) }
  opts.on("--reject REGEX", "Exclude repos with matching names") { |regex| options[:reject] = Regexp.new(regex) }
  opts.on("-h", "--help", "Show this.") { puts opts; exit }
  opts.on("-v", "--version", "Show Version"){ puts RepoDependencyGraph::VERSION; exit}
end.parse!

exit RepoDependencyGraph.run(options)
